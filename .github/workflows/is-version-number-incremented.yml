name: Vérification du numéro de version du plugin Moodle
on: [push, workflow_dispatch]

jobs:
  get_versions:
    runs-on: ubuntu-latest
    env:
      old_version: ""
      new_version: ""

    steps:
      - name: "Checkout version.php file"
        uses: actions/checkout@v3
        with:
          sparse-checkout: |
            version.php
          sparse-checkout-cone-mode: false

      - name: "Extract new version number"
        id: extract_new_version
        run: |
          new_version= cat $GITHUB_WORKSPACE/version.php | grep version | grep -o -E '[0-9]{10}'
          echo "New version: $new_version"

      - name: "Get git tree"
        id: get_git_tree
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: "Extract old version number"
        id: extract_old_version
        run: |
          git checkout HEAD^
          old_version= cat $GITHUB_WORKSPACE/version.php | grep version | grep -o -E '[0-9]{10}'
          echo "Old version: $old_version"

      - name: "Compare versions"
        run: |
          echo "$old_version -> $new_version"
          if [ $((old_version)) < $((new_version)) ]; then
            echo "Le numéro de version a été incrémenté."
            exit 0
          fi
          echo "Le numéro de version n'a pas été incrémenté."
          exit 1

      - name: "Send notification"
        if: ${{ failure() }}
        run: |
          echo "Le numéro de version du plugin Moodle n'a pas été incrémenté. Veuillez vérifier et mettre à jour le numéro de version approprié."
